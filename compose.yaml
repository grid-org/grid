services:
  bootstrap:
    image: nats:latest
    ports:
    - "4222:4222"
    - "8222:8222"
    configs:
    - source: nats
      target: /etc/nats/server.conf
    command: ["-c", "/etc/nats/server.conf", "-n", "bootstrap"]

  nats1:
    image: nats:latest
    configs:
    - source: nats
      target: /etc/nats/server.conf
    command: ["-c", "/etc/nats/server.conf", "-n", "nats1"]

  nats2:
    image: nats:latest
    configs:
    - source: nats
      target: /etc/nats/server.conf
    command: ["-c", "/etc/nats/server.conf", "-n", "nats2"]

  # api:
  #   build:
  #     context: .
  #     target: api
  #   ports:
  #   - "8765:8765"
  #   restart: always
  #   configs:
  #   - source: grid
  #     target: /etc/grid/config.yaml
  #   volumes:
  #   - .:/workspace
  #   command: ["-c", "/etc/grid/config.yaml"]

  controller:
    build:
      context: .
      dockerfile: Dockerfile
      target: controller
    deploy:
      replicas: 1
    restart: always
    configs:
    - source: grid
      target: /etc/grid/config.yaml
    command: ["-c", "/etc/grid/config.yaml"]

  # worker:
  #   build:
  #     context: .
  #     target: worker
  #   deploy:
  #     replicas: 1
  #   restart: always
  #   configs:
  #   - source: grid
  #     target: /etc/grid/config.yaml
  #   command: ["-c", "/etc/grid/config.yaml"]

configs:
  grid:
    content: |
      api:
        host: 0.0.0.0
        port: 8765
      nats:
        urls: ["nats://bootstrap:4222"]
  nats:
    content: |
      listen: 0.0.0.0:4222
      monitor_port: 8222

      cluster {
        name: grid
        listen: 0.0.0.0:6222
        routes: [
          nats://bootstrap:6222
        ]
      }

      jetstream {}
